import{g as W,a as U,t as z,d as Y,e as x,s as G,j as J,m as k,c as $,y as Q,R as l,S as X}from"./index-SNKBwPMT.js";var M={exports:{}},P;function Z(){return P||(P=1,(function(A,u){Object.defineProperty(u,"__esModule",{value:!0});function r(t){return typeof t=="object"&&!("toString"in t)?Object.prototype.toString.call(t).slice(8,-1):t}var a=typeof process=="object"&&!0;function s(t,e){if(!t)throw a?new Error("Invariant failed"):new Error(e())}u.invariant=s;var p=Object.prototype.hasOwnProperty,y=Array.prototype.splice,b=Object.prototype.toString;function m(t){return b.call(t).slice(8,-1)}var v=Object.assign||(function(t,e){return E(e).forEach(function(i){p.call(e,i)&&(t[i]=e[i])}),t}),E=typeof Object.getOwnPropertySymbols=="function"?function(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.keys(t)};function d(t){return Array.isArray(t)?v(t.constructor(t.length),t):m(t)==="Map"?new Map(t):m(t)==="Set"?new Set(t):t&&typeof t=="object"?v(Object.create(Object.getPrototypeOf(t)),t):t}var C=(function(){function t(){this.commands=v({},S),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(e,i){return e===i},this.update.newContext=function(){return new t().update}}return Object.defineProperty(t.prototype,"isEquals",{get:function(){return this.update.isEquals},set:function(e){this.update.isEquals=e},enumerable:!0,configurable:!0}),t.prototype.extend=function(e,i){this.commands[e]=i},t.prototype.update=function(e,i){var n=this,o=typeof i=="function"?{$apply:i}:i;Array.isArray(e)&&Array.isArray(o)||s(!Array.isArray(o),function(){return"update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value."}),s(typeof o=="object"&&o!==null,function(){return"update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the "+("following commands: "+Object.keys(n.commands).join(", ")+".")});var c=e;return E(o).forEach(function(h){if(p.call(n.commands,h)){var H=e===c;c=n.commands[h](o[h],c,o,e),H&&n.isEquals(c,e)&&(c=e)}else{var L=m(e)==="Map"?n.update(e.get(h),o[h]):n.update(e[h],o[h]),I=m(c)==="Map"?c.get(h):c[h];(!n.isEquals(L,I)||typeof L>"u"&&!p.call(e,h))&&(c===e&&(c=d(e)),m(c)==="Map"?c.set(h,L):c[h]=L)}}),c},t})();u.Context=C;var S={$push:function(t,e,i){return T(e,i,"$push"),t.length?e.concat(t):e},$unshift:function(t,e,i){return T(e,i,"$unshift"),t.length?t.concat(e):e},$splice:function(t,e,i,n){return _(e,i),t.forEach(function(o){N(o),e===n&&o.length&&(e=d(n)),y.apply(e,o)}),e},$set:function(t,e,i){return q(i),t},$toggle:function(t,e){g(t,"$toggle");var i=t.length?d(e):e;return t.forEach(function(n){i[n]=!e[n]}),i},$unset:function(t,e,i,n){return g(t,"$unset"),t.forEach(function(o){Object.hasOwnProperty.call(e,o)&&(e===n&&(e=d(n)),delete e[o])}),e},$add:function(t,e,i,n){return w(e,"$add"),g(t,"$add"),m(e)==="Map"?t.forEach(function(o){var c=o[0],h=o[1];e===n&&e.get(c)!==h&&(e=d(n)),e.set(c,h)}):t.forEach(function(o){e===n&&!e.has(o)&&(e=d(n)),e.add(o)}),e},$remove:function(t,e,i,n){return w(e,"$remove"),g(t,"$remove"),t.forEach(function(o){e===n&&e.has(o)&&(e=d(n)),e.delete(o)}),e},$merge:function(t,e,i,n){return R(e,t),E(t).forEach(function(o){t[o]!==e[o]&&(e===n&&(e=d(n)),e[o]=t[o])}),e},$apply:function(t,e){return B(t),t(e)}},f=new C;u.isEquals=f.update.isEquals,u.extend=f.extend,u.default=f.update,u.default.default=A.exports=v(u.default,u);function T(t,e,i){s(Array.isArray(t),function(){return"update(): expected target of "+r(i)+" to be an array; got "+r(t)+"."}),g(e[i],i)}function g(t,e){s(Array.isArray(t),function(){return"update(): expected spec of "+r(e)+" to be an array; got "+r(t)+". Did you forget to wrap your parameter in an array?"})}function _(t,e){s(Array.isArray(t),function(){return"Expected $splice target to be an array; got "+r(t)}),N(e.$splice)}function N(t){s(Array.isArray(t),function(){return"update(): expected spec of $splice to be an array of arrays; got "+r(t)+". Did you forget to wrap your parameters in an array?"})}function B(t){s(typeof t=="function",function(){return"update(): expected spec of $apply to be a function; got "+r(t)+"."})}function q(t){s(Object.keys(t).length===1,function(){return"Cannot have more than one key in an object with $set"})}function R(t,e){s(e&&typeof e=="object",function(){return"update(): $merge expects a spec of type 'object'; got "+r(e)}),s(t&&typeof t=="object",function(){return"update(): $merge expects a target of type 'object'; got "+r(t)})}function w(t,e){var i=m(t);s(i==="Map"||i==="Set",function(){return"update(): "+r(e)+" expects a target of type Set or Map; got "+r(i)})}})(M,M.exports)),M.exports}var F=Z();const D=W(F);var K=(function(A){U(u,A);function u(r){var a=A.call(this,r)||this;return a.state={items:r.items?r.items.concat():[]},a.handleLoaded=a.handleLoaded.bind(a),a.tick=a.tick.bind(a),a}return u.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},u.prototype.componentDidUpdate=function(r){var a=this.props;r.items!==a.items?this.setState({items:a.items?a.items.concat():[]}):J(r.checkApi,a.checkApi,r.data,a.data)&&this.tick(!0)},u.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},u.prototype.reload=function(){this.tick(!0)},u.prototype.tick=function(r){var a=this;r===void 0&&(r=!1);var s=this.props,p=s.loadingStatusCode,y=s.data,b=s.interval,m=s.checkApi,v=s.env,E=this.state.items;if(clearTimeout(this.timer),!(!r&&!E.some(function(d){return d.status===p}))){if(b&&!k(m))return v.alert("checkApi 没有设置, 不能及时获取任务状态");k(m,y)&&v&&v.fetcher(m,y).then(this.handleLoaded).catch(function(d){return a.setState({error:d})})}},u.prototype.handleLoaded=function(r){if(!Array.isArray(r.data))return this.props.env.alert("返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息");this.setState({items:r.data});var a=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,a)},u.prototype.submitTask=function(r,a,s){var p=this;s===void 0&&(s=!1);var y=this.props,b=y.submitApi,m=y.reSubmitApi,v=y.loadingStatusCode,E=y.errorStatusCode,d=y.data,C=y.env;if(!s&&!k(b))return C.alert("submitApi 没有配置");if(s&&!k(m))return C.alert("reSubmitApi 没有配置");this.setState(D(this.state,{items:{$splice:[[a,1,$($({},r),{status:v})]]}}));var S=s?m:b;k(S,d)&&C&&C.fetcher(S,Q(d,r)).then(function(f){if(f&&f.data){if(Array.isArray(f.data))p.handleLoaded(f);else{S&&S.replaceData;var T=p.state.items.map(function(g){return g.key===f.data.key?$($({},S.replaceData?{}:g),f.data):g});p.handleLoaded($($({},f),{data:T}))}return}clearTimeout(p.timer),p.timer=setTimeout(p.tick,4)}).catch(function(f){return p.setState(D(p.state,{items:{$splice:[[a,1,$($({},r),{status:E,remark:f.message||f})]]}}))})},u.prototype.render=function(){var r=this,a=this.props,s=a.classnames,p=a.className,y=a.style,b=a.tableClassName,m=a.taskNameLabel,v=a.operationLabel,E=a.statusLabel,d=a.remarkLabel,C=a.btnText,S=a.retryBtnText,f=a.btnClassName,T=a.retryBtnClassName,g=a.statusLabelMap,_=a.statusTextMap,N=a.readyStatusCode,B=a.loadingStatusCode,q=a.canRetryStatusCode,R=a.translate,w=a.render,t=a.loadingConfig,e=this.state.items,i=this.state.error;return l.createElement("div",{className:s("Table-content",p),style:y},l.createElement("table",{className:s("Table-table",b)},l.createElement("thead",null,l.createElement("tr",null,l.createElement("th",null,m),l.createElement("th",null,R(v)),l.createElement("th",null,E),l.createElement("th",null,d))),l.createElement("tbody",null,i?l.createElement("tr",null,l.createElement("td",{colSpan:4},l.createElement("div",{className:"text-danger"},i))):e.map(function(n,o){var c;return l.createElement("tr",{key:o},l.createElement("td",null,l.createElement("span",{className:s("word-break")},n.label)),l.createElement("td",null,n.status==B?l.createElement(X,{loadingConfig:t,show:!0,icon:"reload",spinnerClassName:s("Task-spinner")}):n.status==q?l.createElement("a",{onClick:function(){return r.submitTask(n,o,!0)},className:s("Button","Button--danger","Button--size-md",T||f)},S||C):l.createElement("a",{onClick:function(){return r.submitTask(n,o)},className:s("Button","Button--default","Button--size-md",f,(c={},c["is-disabled"]=n.status!==N,c))},C)),l.createElement("td",null,l.createElement("span",{className:s("label",g&&g[n.status||0])},_&&_[n.status||0])),l.createElement("td",null,n.remark?w("".concat(o,"/remark"),n.remark):null))}))))},u.defaultProps={className:"",tableClassName:"",taskNameLabel:"任务名称",operationLabel:"Table.operation",statusLabel:"状态",remarkLabel:"备注说明",btnText:"上线",retryBtnText:"重试",btnClassName:"",retryBtnClassName:"",statusLabelMap:["label-warning","label-info","label-info","label-danger","label-success","label-danger"],statusTextMap:["未开始","就绪","进行中","出错","已完成","出错"],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},u})(l.Component),O=(function(A){U(u,A);function u(r,a){var s=A.call(this,r)||this,p=a;return p.registerComponent(s),s}return u.prototype.componentWillUnmount=function(){A.prototype.componentWillUnmount.call(this);var r=this.context;r.unRegisterComponent(this)},u.contextType=z,u=Y([x({type:"tasks"}),G("design:paramtypes",[Object,Object])],u),u})(K);export{O as TaskRenderer,K as default};
