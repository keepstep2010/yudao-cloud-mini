const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-Du3plbSe.js","assets/index-SNKBwPMT.js","assets/index-DWr5F6YA.css"])))=>i.map(i=>d[i]);
import{a as B,d as b,F as W,R as h,a2 as P,am as j,ax as U,c5 as V,ac as D,ca as X,f as F,h as C,aP as R,av as T,aj as _,c as S,cb as J,ap as k,_ as w,bh as q,M as H,cc as L,T as z,I as O,q as I,s as g}from"./index-SNKBwPMT.js";var $=(function(x){B(d,x);function d(){var r=x!==null&&x.apply(this,arguments)||this;return r.state={files:[]},r.dropzone=h.createRef(),r}return d.prototype.componentDidUpdate=function(r){r.value!==this.props.value&&!this.props.value&&this.setState({files:[]}),r.value!==this.props.value&&this.props.value&&this.triggerAutoFill()},d.prototype.syncAutoFill=function(r,a){var n=this.props,t=n.autoFill,s=n.onBulkChange,u=n.data,e=n.name,c=n.multiple;if(!(t?.hasOwnProperty("api")||!P(t))){var l=e?j(t,e):t;if(!U(l)&&s){var p=void 0;if(c===!0){var i=this.state.files.filter(function(o){return o.state==="parsed"}).map(function(o){return{filename:o.name,data:o.data}});p={items:i,currentFile:{filename:r,data:a}}}else p={filename:r};var f=V(l,p);Object.keys(f).forEach(function(o){D(f[o])&&D(u[o])&&(f[o]=X({},u[o],f[o]))}),s(f)}}},d.prototype.handleDrop=function(r){return F(this,void 0,void 0,function(){var a,n,t,s,u,e,c=this;return C(this,function(l){return a=this.props,n=a.maxLength,t=a.multiple,r.length?t?(u=n?n-this.state.files.length:r.length,u<=0?[2]:(e=r.slice(0,u).map(function(p){return{file:p,id:R()}}),this.setState(function(p){return{files:T(T([],_(p.files),!1),_(e.map(function(i){var f=i.file,o=i.id;return{id:o,name:f.name,state:"pending"}})),!1)}},function(){c.processFiles(e)}),[2])):(s=[{file:r[0],id:R()}],this.setState({files:s.map(function(p){var i=p.file,f=p.id;return{id:f,name:i.name,state:"pending"}})},function(){c.processFiles(s)}),[2]):[2]})})},d.prototype.processFiles=function(r){return F(this,void 0,void 0,function(){var a,n=this;return C(this,function(t){switch(t.label){case 0:return a=r.map(function(s){var u=s.file,e=s.id,c=n.state.files.find(function(l){return l.id===e&&l.state==="pending"});return c?{file:u,fileState:c}:null}).filter(function(s){return s!==null}),a.length?[4,Promise.all(a.map(function(s){var u=s.file,e=s.fileState;return n.processExcelFile(u,e)}))]:[3,2];case 1:return t.sent(),[3,3];case 2:this.updateFormValue(),t.label=3;case 3:return[2]}})})},d.prototype.handleSelect=function(){var r=this.props,a=r.disabled,n=r.maxLength,t=r.multiple,s=t===!0||this.state.files.length===0;!a&&!(n&&this.state.files.length>=n)&&s&&this.dropzone.current&&this.dropzone.current.open()},d.prototype.removeFile=function(r){var a=this;this.setState(function(n){return{files:n.files.filter(function(t){return t.id!==r.id})}},function(){var n=a.state.files.filter(function(t){return t.state==="pending"});n.length===0&&a.updateFormValue()})},d.prototype.updateFileState=function(r,a){var n=this;this.setState(function(t){return{files:t.files.map(function(s){return s.id===r?S(S({},s),a):s})}},function(){if(a.state==="parsed"){var t=n.state.files.filter(function(s){return s.state==="pending"});t.length===0&&n.updateFormValue()}})},d.prototype.updateFormValue=function(){return F(this,void 0,void 0,function(){var r,a,n,t,s,u,e,c,l;return C(this,function(p){switch(p.label){case 0:return r=this.props,a=r.data,n=r.multiple,t=r.allSheets,s=r.parseImage,u=this.state.files.filter(function(i){return i.state==="parsed"}),u.length!==0?[3,2]:[4,this.dispatchEvent("change")];case 1:return p.sent(),this.props.onChange(void 0),[2];case 2:return n===!0?e=u.map(function(i){var f=Array.isArray(i.data)?i.data:[i.data];return{fileName:i.name,data:f.map(function(o){var v={sheetName:o.sheetName||"Sheet1",data:o.data||o};return s&&o.images&&(v.images=o.images),v})}}):(c=u[0],t?e=Array.isArray(c.data)?c.data:[c.data]:e=c.data),e&&J(e)&&(e=k(a,e)),[4,this.dispatchEvent("change",e)];case 3:return l=p.sent(),l?.prevented?[2]:(this.props.onChange(e),this.triggerAutoFill(),[2])}})})},d.prototype.triggerAutoFill=function(){var r=this.props.autoFill;if(r&&!r.hasOwnProperty("api")&&P(r)){var a=this.state.files.filter(function(t){return t.state==="parsed"});if(a.length>0){var n=a[a.length-1];this.syncAutoFill(n.name,n.data)}}},d.prototype.processExcelFile=function(r,a){return F(this,void 0,void 0,function(){var n,t,s,u,e,c,l,p;return C(this,function(i){switch(i.label){case 0:n=this.props.translate,i.label=1;case 1:return i.trys.push([1,7,,8]),[4,new Promise(function(f,o){var v=new FileReader;v.onload=function(){v.result?f(v.result):o(new Error("Failed to read file"))},v.onerror=function(){return o(v.error)},v.readAsArrayBuffer(r)})];case 2:return t=i.sent(),s=r.name.toLowerCase().endsWith(".xls"),u=void 0,s?[4,w(()=>import("./xlsx-DGuHH-KN.js"),[])]:[3,4];case 3:return e=i.sent(),c=e.read(new Uint8Array(t),{cellDates:!0}),l=e.writeXLSX(c,{type:"array"}),u=l.buffer,[3,5];case 4:u=t,i.label=5;case 5:return[4,this.parseExcelData(u,a)];case 6:return i.sent(),[3,8];case 7:return p=i.sent(),console.error("Excel parsing error:",p),this.updateFileState(a.id,{state:"error",error:p.message||n("Excel.parseError")}),[3,8];case 8:return[2]}})})},d.prototype.parseExcelData=function(r,a){return F(this,void 0,void 0,function(){var n,t,s,u,e,c,l,p,i,f,o;return C(this,function(v){switch(v.label){case 0:n=this.props,t=n.allSheets,s=n.parseImage,u=n.plainText,e=n.translate,v.label=1;case 1:return v.trys.push([1,4,,5]),[4,w(()=>import("./exceljs.min-Du3plbSe.js").then(m=>m.e),__vite__mapDeps([0,1,2]))];case 2:return c=v.sent().default,this.ExcelJS=c,l=new c.Workbook,p=typeof r=="string"?new Uint8Array(r.split("").map(function(m){return m.charCodeAt(0)})).buffer:r,[4,l.xlsx.load(p)];case 3:return v.sent(),i=void 0,t?i=this.parseAllSheets(l,s,u):(f=l.worksheets.find(function(m){return m.state!=="hidden"}),i=s?{data:this.readWorksheet(f,u),images:this.readImages(f,l)}:this.readWorksheet(f,u)),this.updateFileState(a.id,{state:"parsed",data:i}),[3,5];case 4:return o=v.sent(),console.error("Excel parsing error:",o),this.updateFileState(a.id,{state:"error",error:o.message||e("Excel.parseError")}),[3,5];case 5:return[2]}})})},d.prototype.parseAllSheets=function(r,a,n){var t=this;a===void 0&&(a=!1),n===void 0&&(n=!0);var s=[];return r.eachSheet(function(u){var e=u.state||"visible";if(e!=="hidden"){var c={sheetName:u.name,data:t.readWorksheet(u,n)};a&&(c.images=t.readImages(u,r)),s.push(c)}}),s},d.prototype.readImages=function(r,a){var n,t,s=this.props.imageDataURI,u=r.getImages(),e=[];try{for(var c=q(u),l=c.next();!l.done;l=c.next()){var p=l.value,i=a.getImage(+p.imageId),f=this.encodeBase64Bytes(i.buffer);if(s){var o=i.extension||"png";e.push("data:image/".concat(o,";base64,")+f)}else e.push(f)}}catch(v){n={error:v}}finally{try{l&&!l.done&&(t=c.return)&&t.call(c)}finally{if(n)throw n.error}}return e},d.prototype.encodeBase64Bytes=function(r){return btoa(r.reduce(function(a,n){return a+String.fromCharCode(n)},""))},d.prototype.dispatchEvent=function(r,a){return F(this,void 0,void 0,function(){var n;return C(this,function(t){switch(t.label){case 0:return n=this.props.dispatchEvent,[4,n(r,H(this.props,{value:a}))];case 1:return[2,t.sent()]}})})},d.prototype.isRichTextValue=function(r){return!!(r&&P(r)&&r.hasOwnProperty("richText")&&Array.isArray(r?.richText))},d.prototype.richText2PlainString=function(r,a){a===void 0&&(a=!1);var n=r.richText.map(function(t){var s=t.text,u=t.font,e=u===void 0?{}:u,c=s;if(a){var l="",p=e?.bold?"strong":e?.italic?"em":e?.vertAlign==="superscript"?"sup":e?.vertAlign==="subscript"?"sub":"span";e?.strike?l+="text-decoration: line-through;":e?.underline&&(l+="text-decoration: underline;"),e?.outline&&(l+="outline: solid;"),e?.size&&(l+="font-size: ".concat(e.size,"px;")),c="<".concat(p," ").concat(l?"style=".concat(l):"",">").concat(s,"</").concat(p,">")}return c});return n.join("")},d.prototype.readWorksheet=function(r,a){var n=this;a===void 0&&(a=!0);var t=[],s=this.props,u=s.parseMode,e=s.includeEmpty;if(u==="array")return r.eachRow(function(l){var p=l.values;p.shift(),a&&(p=p.map(function(i){if(i instanceof Object){if(i.hyperlink)return i.hyperlink.startsWith("mailto:")?i.hyperlink.substring(7):i.hyperlink;if(i.result)return i.result;if(i.richText)return n.richText2PlainString(i)}return i})),t.push(p)}),t;var c=[];return r.eachRow(function(l,p){var i;if(p==1)c=((i=l.values)!==null&&i!==void 0?i:[]).map(function(o){return n.isRichTextValue(o)?n.richText2PlainString(o):o});else{var f={};e&&c.forEach(function(o){f[o]=""}),l.eachCell(function(o,v){if(c[v]){var m=o.value;if(a){var y=n.ExcelJS.ValueType;o.type===y.Hyperlink?(m=o.value.hyperlink,m.startsWith("mailto:")&&(m=m.substring(7))):o.type===y.Formula?m=o.value.result:o.type===y.RichText?m=n.richText2PlainString(o.value):o.type===y.Error&&(m="")}f[c[v]]=m}}),t.push(f)}}),t},d.prototype.doAction=function(r,a,n){var t,s,u=r?.actionType,e=this.props,c=e.onChange,l=e.resetValue,p=e.formStore,i=e.store,f=e.name;if(u==="clear")c("");else if(u==="reset"){var o=(s=k((t=p?.pristine)!==null&&t!==void 0?t:i?.pristine,f))!==null&&s!==void 0?s:l;c(o??"")}},d.prototype.render=function(){var r=this,a=this.props,n=a.className,t=a.classnames,s=a.maxLength,u=a.disabled,e=a.translate,c=a.placeholder,l=a.testIdBuilder,p=a.multiple,i=a.env,f=a.container,o=this.state.files,v=!!s&&o.length>=s;return p!==!0?h.createElement("div",{className:t("ExcelControl",n)},h.createElement(L,{key:"drop-zone",ref:this.dropzone,onDrop:this.handleDrop,accept:".xlsx,.xls",multiple:!1,disabled:u},function(m){var y=m.getRootProps,A=m.getInputProps;return h.createElement("section",{className:t("ExcelControl-container",n)},h.createElement("div",S({},y({className:t("ExcelControl-dropzone")}),l?.getTestId()),h.createElement("input",S({},A(),l?.getChild("input").getTestId())),o.length>0&&o[0].state==="parsed"?h.createElement("p",null,e("Excel.parsed",{filename:o[0].name})):h.createElement("p",null,c??e("Excel.placeholder"))))})):h.createElement("div",{className:t("ExcelControl",n)},h.createElement(L,{key:"drop-zone",ref:this.dropzone,onDrop:this.handleDrop,accept:".xlsx,.xls",multiple:!!p,disabled:u||v,noClick:!0},function(m){var y=m.getRootProps,A=m.getInputProps,N=m.isDragActive;return h.createElement("div",S({},y({className:t("ExcelControl-container",n)})),h.createElement(z,{placement:"top",container:f||i?.getModalContainer,tooltip:s===1?e("Excel.singleFile"):s?e("File.maxLength",{maxLength:s,uploaded:o.length}):"",tooltipClassName:t("ExcelControl-tooltip")},h.createElement("div",{className:t("ExcelControl-dropzone",{"is-disabled":u||v,"is-empty":!o.length,"is-active":N}),onClick:u||v?void 0:r.handleSelect},h.createElement("input",S({},A(),l?.getChild("input").getTestId())),N?h.createElement("div",{className:t("ExcelControl-acceptTip")},h.createElement("p",null,e("File.dragDrop"))):h.createElement("div",{className:t("ExcelControl-acceptTip")},h.createElement("p",null,c??e("Excel.placeholder"))))),o.length>0&&h.createElement("ul",{className:t("ExcelControl-list")},o.map(function(E){return h.createElement("li",{key:E.id},h.createElement(z,{placement:"top",container:f||i?.getModalContainer,tooltipClassName:t("ExcelControl-list-tooltip",E.state==="error"&&"is-invalid"),tooltip:E.state==="error"?E.error:E.name},h.createElement("div",{className:t("ExcelControl-itemInfo",{"is-invalid":E.state==="error"})},h.createElement("span",{className:t("ExcelControl-itemInfoIcon")},h.createElement(O,{icon:"file-excel",className:"icon"})),h.createElement("span",{className:t("ExcelControl-itemInfoText")},E.name),!u&&h.createElement("a",{"data-tooltip":e("Select.clear"),"data-position":"left",className:t("ExcelControl-clear"),onClick:function(M){M.stopPropagation(),r.removeFile(E)}},h.createElement(O,{icon:"close",className:"icon"})))),E.state==="pending"&&h.createElement("div",{className:t("ExcelControl-progressInfo")},h.createElement("p",null,e("Excel.parsing"))))})))}))},d.defaultProps={allSheets:!1,parseMode:"object",includeEmpty:!0,plainText:!0,parseImage:!1,imageDataURI:!0},b([I,g("design:type",Function),g("design:paramtypes",[String,Object]),g("design:returntype",void 0)],d.prototype,"syncAutoFill",null),b([I,g("design:type",Function),g("design:paramtypes",[Array]),g("design:returntype",Promise)],d.prototype,"handleDrop",null),b([I,g("design:type",Function),g("design:paramtypes",[]),g("design:returntype",void 0)],d.prototype,"handleSelect",null),b([I,g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",void 0)],d.prototype,"removeFile",null),b([I,g("design:type",Function),g("design:paramtypes",[]),g("design:returntype",Promise)],d.prototype,"updateFormValue",null),d})(h.PureComponent),K=(function(x){B(d,x);function d(){return x!==null&&x.apply(this,arguments)||this}return d=b([W({type:"input-excel"})],d),d})($);export{K as ExcelControlRenderer,$ as default};
